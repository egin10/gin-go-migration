#!/usr/bin/env bash

# ===========================================================
# gin-go-migration
# CLI tool for creating and running SQL migrations in Go
# ===========================================================

set -e

VERSION="1.1.0"
REPO_URL="https://raw.githubusercontent.com/egin10/gin-go-migration/main/gin-go-migration"

COMMAND=$1
shift || true

# Default config
SOURCE_DIR="database/migrations"
DB_TYPE="postgres"
DB_USER=""
DB_PASS=""
DB_HOST="localhost"
DB_PORT="5432"
DB_NAME=""
SSL_MODE="disable"
ACTION=""

# ===========================================================
# FUNCTIONS
# ===========================================================

function check_migrate_installed() {
  if ! command -v migrate &> /dev/null; then
    echo "‚ùå 'migrate' command not found!"
    echo "Please install golang-migrate first:"
    echo ""
    echo "üëâ macOS / Linux:"
    echo "   curl -L https://packagecloud.io/golang-migrate/migrate/gpgkey | sudo apt-key add -"
    echo "   sudo apt-get install -y migrate"
    echo ""
    echo "üëâ Or manually from https://github.com/golang-migrate/migrate/releases"
    exit 1
  fi
}

function show_help() {
  echo "Usage:"
  echo "  gin-go-migration create <name> [-o output_dir]"
  echo "  gin-go-migration migrate -s <source> -db <type> -u <user> -p <pass> -h <host> -port <port> -n <dbname> [-ssl <mode>] <up|down [-N]>"
  echo "  gin-go-migration update"
  echo "  gin-go-migration version"
  echo ""
  echo "Examples:"
  echo "  gin-go-migration create add_users_table"
  echo "  gin-go-migration migrate -s database/migrations -db postgres -u mintegra -p secret -h 127.0.0.1 -port 5432 -n operation up"
  echo "  gin-go-migration migrate -s database/migrations -db postgres -u mintegra -p secret -h 127.0.0.1 -port 5432 -n operation down -1"
  echo "  gin-go-migration update"
  echo "  gin-go-migration version"
  exit 0
}

function check_for_update() {
  echo "üîç Checking for updates..."

  # Check dependencies
  if ! command -v curl >/dev/null 2>&1 && ! command -v wget >/dev/null 2>&1; then
    echo "‚ùå curl or wget is required for update."
    exit 1
  fi

  # Download remote version
  TMP_FILE=$(mktemp)
  if command -v curl >/dev/null 2>&1; then
    curl -s -L "$REPO_URL" -o "$TMP_FILE"
  else
    wget -q "$REPO_URL" -O "$TMP_FILE"
  fi

  REMOTE_VERSION=$(grep -m1 '^VERSION=' "$TMP_FILE" | cut -d'"' -f2)

  if [ -z "$REMOTE_VERSION" ]; then
    echo "‚ö†Ô∏è Unable to check remote version."
    rm -f "$TMP_FILE"
    exit 1
  fi

  if [ "$REMOTE_VERSION" != "$VERSION" ]; then
    echo "üöÄ New version available: $REMOTE_VERSION (current: $VERSION)"
    read -p "Update now? (y/N): " yn
    case $yn in
      [Yy]* )
        chmod +x "$TMP_FILE"
        if [[ "$OSTYPE" == "linux-gnu"* || "$OSTYPE" == "darwin"* ]]; then
          sudo mv "$TMP_FILE" /usr/local/bin/gin-go-migration
        elif [[ "$OS" == "Windows_NT" ]]; then
          mv "$TMP_FILE" "C:\\Program Files\\gin-go-migration\\gin-go-migration"
        else
          echo "‚ö†Ô∏è Unsupported OS for auto-update."
          rm -f "$TMP_FILE"
          exit 1
        fi
        echo "‚úÖ gin-go-migration updated to $REMOTE_VERSION"
        ;;
      * )
        echo "‚ùå Update canceled."
        rm -f "$TMP_FILE"
        ;;
    esac
  else
    echo "‚úÖ You‚Äôre already using the latest version ($VERSION)"
    rm -f "$TMP_FILE"
  fi
}

function show_version() {
  echo "gin-go-migration version $VERSION"
}

# ===========================================================
# COMMAND HANDLER
# ===========================================================

case "$COMMAND" in
  create)
    NAME=$1
    shift || true
    while [[ $# -gt 0 ]]; do
      case $1 in
        -o|--output)
          SOURCE_DIR="$2"
          shift 2
          ;;
        *)
          shift
          ;;
      esac
    done

    if [ -z "$NAME" ]; then
      echo "‚ùå Missing migration name!"
      echo "Usage: gin-go-migration create <name>"
      exit 1
    fi

    TIMESTAMP=$(date +"%Y%m%d%H%M%S")
    mkdir -p "$SOURCE_DIR"
    UP_FILE="$SOURCE_DIR/${TIMESTAMP}_${NAME}.up.sql"
    DOWN_FILE="$SOURCE_DIR/${TIMESTAMP}_${NAME}.down.sql"

    echo "-- Migration: $NAME" > "$UP_FILE"
    echo "-- Created at: $(date)" >> "$UP_FILE"
    echo -e "\n-- Write your UP SQL here" >> "$UP_FILE"

    echo "-- Rollback: $NAME" > "$DOWN_FILE"
    echo "-- Created at: $(date)" >> "$DOWN_FILE"
    echo -e "\n-- Write your DOWN SQL here" >> "$DOWN_FILE"

    echo "‚úÖ Migration files created:"
    echo " - $UP_FILE"
    echo " - $DOWN_FILE"
    ;;

  migrate)
    check_migrate_installed

    while [[ $# -gt 0 ]]; do
      case $1 in
        -s|--source)
          SOURCE_DIR="$2"
          shift 2
          ;;
        -db|--database)
          DB_TYPE="$2"
          shift 2
          ;;
        -u|--user)
          DB_USER="$2"
          shift 2
          ;;
        -p|--password)
          DB_PASS="$2"
          shift 2
          ;;
        -h|--host)
          DB_HOST="$2"
          shift 2
          ;;
        -port|--port)
          DB_PORT="$2"
          shift 2
          ;;
        -n|--name)
          DB_NAME="$2"
          shift 2
          ;;
        -ssl|--sslmode)
          SSL_MODE="$2"
          shift 2
          ;;
        up|down)
          ACTION=$1
          shift
          ;;
        *)
          ACTION_ARGS="$1"
          shift
          ;;
      esac
    done

    if [ -z "$ACTION" ]; then
      echo "‚ùå Missing action! (use: up | down [-N])"
      exit 1
    fi

    if [ -z "$DB_USER" ] || [ -z "$DB_PASS" ] || [ -z "$DB_NAME" ]; then
      echo "‚ùå Missing database credentials! Please provide -u, -p, and -n"
      exit 1
    fi

    DB_URL="${DB_TYPE}://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${SSL_MODE}"

    echo "üöÄ Running migration..."
    echo "   Source: ${SOURCE_DIR}"
    echo "   DB URL: ${DB_URL}"

    migrate -path "$SOURCE_DIR" -database "$DB_URL" "$ACTION" $ACTION_ARGS
    ;;

  update)
    check_for_update
    ;;

  version)
    show_version
    ;;

  help|--help|-h)
    show_help
    ;;

  *)
    echo "‚ùå Unknown command: $COMMAND"
    show_help
    ;;
esac
